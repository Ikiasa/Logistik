# Logistik Frontend Integration Guide (Backend v2)

**Version:** 1.0
**Target Audience:** Web (React) & Mobile (Flutter) Developers
**Status:** Backend Enterprise Ready

This document details the technical requirements for integrating with the hardened Logistik Backend v2.

## 1. Authentication & Tenant Context
The backend enforces strict Multi-Tenancy via Row-Level Security (RLS).

### 1.1. Login Flow (Mock SSO)
Until a real IdP is connected, use the `MockSSOStrategy`:
1.  **Header:** Send `x-sso-token` with one of the valid mock tokens:
    *   `valid-token-tenant-a` (Alice, Tenant A)
    *   `valid-token-tenant-b` (Bob, Tenant B)
2.  **Response:** Backend returns a JWT (or session cookie).
3.  **Subsequent Requests:** Attach the token in `Authorization: Bearer <token>`.

### 1.2. Protocol
*   **Web/Mobile:** The backend handles `tenant_id` resolution automatically from the User context. You do **not** need to manually send `x-tenant-id` unless performing public/system calls (which should be rare).

## 2. API v2 & Idempotency
All transactional endpoints (Create Order, Update Status, PoD) require idempotency.

### 2.1. Idempotency Key
*   **Requirement:** Every `POST/PUT/PATCH` request **MUST** include the `Idempotency-Key` header.
*   **Format:** UUID v4 (optimally generated by the client).
*   **Behavior:**
    *   **First Request:** 201 Created / 200 OK.
    *   **Retry (Network Fail):** 200/201 (Returns cached response body).
    *   **Conflict:** 409 (If request payload changes for same Key).
*   **Client Logic:**
    ```javascript
    // Example (JS)
    const idempotencyKey = uuidv4();
    await api.post('/v2/orders', data, { headers: { 'Idempotency-Key': idempotencyKey } });
    ```

### 2.2. Deprecation Warnings
*   **Header:** `Warning: 299 - "This endpoint is deprecated..."`
*   **Action:** Log these warnings in Dev/Staging. Migrate any v1 calls to v2 immediately.

## 3. Financial Integrity
Money is handled as integers (cents) with strict currency checks.

### 3.1. Data Format
```json
{
  "total_amount": 10500, // $105.00
  "total_currency": "USD"
}
```
*   **Validation:** DO NOT send floats (`105.00`). The backend will reject them.

## 4. Mobile Specifics (PoD)

### 4.1. Offline Sync (Outbox Pattern)
*   The Mobile App should implement a local Outbox.
*   **Process:**
    1.  Driver captures Signature/Photo offline.
    2.  App stores event `OrderDelivered` locally.
    3.  Connectivity restored -> App flushes events to `POST /v2/orders/:id/pod`.
    4.  **Critical:** Reuse the original `Idempotency-Key` generated when the signature was captured to prevent duplicates during flaky sync.

## 5. Error Handling Standards
| Status | Meaning | Client Action |
| :--- | :--- | :--- |
| **400** | Bad Request | Fix Payload (Check Money format). |
| **401** | Unauthorized | Re-login (SSO Token expired). |
| **409** | Conflict | Idempotency mismatch. Generate new Key or check state. |
| **429** | Too Many Requests | Backoff and retry (Exponential). |
| **500** | Server Error | Alert Support (Correlation ID in header). |
